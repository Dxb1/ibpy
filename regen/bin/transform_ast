#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os.path
import sys

from lib import lexer
from lib import parser
from lib import walker


def transform(filename):
    if filename:
        args = [filename, ]        
    else:
        args = []
    
    L = lexer.Lexer(*args)
    P = parser.Parser(L)
    #P.setFilename(L.getFilename())

    try:
        P.compilationUnit()
    except (Exception, ), exc:
       print '*** exception while parsing:'
       print exc
       return 1

    ast = P.getAST()
    if not ast:
       print '*** error: no AST generated.'
       return 2

    W = walker.Walker()
    if filename:
        filein = os.path.basename(filename)
        fileout = '%s.py' % (os.path.splitext(filein)[0])
    else:
        filein = fileout = '-'
    print '\n'*2
    print W.module(ast, filein, fileout)
    print '\n'*2    
    return 0


if __name__ == '__main__':
    import psyco
    psyco.full()

    try:
        name = sys.argv[1]
    except (IndexError, ):
        name = None

    ret = transform(name)
    sys.exit(ret)

